package com.GASB.anti_malware.service.dlp;

import org.apache.poi.hwpf.HWPFDocument;
import org.apache.poi.hwpf.usermodel.Picture;
import org.apache.poi.hwpf.usermodel.Range;
import org.apache.poi.xwpf.usermodel.XWPFDocument;
import org.apache.poi.xwpf.usermodel.XWPFPictureData;
import org.apache.poi.xwpf.usermodel.XWPFParagraph;
import org.apache.tika.Tika;
import org.apache.tika.exception.TikaException;
import org.springframework.stereotype.Service;
import lombok.extern.slf4j.Slf4j;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.List;

@Service
@Slf4j
public class DlpService {

    public void dlpTika() {
        // DOCX 파일의 경로를 지정합니다.
        File file = new File("src/main/java/com/GASB/anti_malware/files/doc/test.docx");

        // Tika 인스턴스를 생성합니다.
        Tika tika = new Tika();

        try {
            // Tika를 사용하여 파일에서 텍스트를 추출합니다.
            String extractedText = tika.parseToString(file);

            // 추출된 텍스트를 로그로 출력합니다.
            System.out.println("파일 내용: " + extractedText);

        } catch (IOException | TikaException e) {
            // 파일 읽기 또는 텍스트 추출 중 오류가 발생한 경우 예외를 처리합니다.
            System.out.println("[ERROR] " + e.getMessage());
        }
    }

    public void dlpPOI() {
        String filePath = "src/main/java/com/GASB/anti_malware/files/doc/test.docx";
        if (filePath.endsWith(".doc")) {
            extractTextAndImagesFromDoc(filePath);
        } else if (filePath.endsWith(".docx")) {
            extractTextAndImagesFromDocx(filePath);
        } else {
            System.out.println("[ERROR] Unsupported file format");
        }
    }

    private void extractTextAndImagesFromDoc(String filePath) {
        try (FileInputStream fis = new FileInputStream(filePath);
             HWPFDocument document = new HWPFDocument(fis)) {

            // 문서에서 이미지 목록을 가져옵니다.
            List<Picture> pictures = document.getPicturesTable().getAllPictures();

            for (int i = 0; i < pictures.size(); i++) {
                Picture picture = pictures.get(i);
                String imageFileName = "extracted_image_" + (i + 1) + "." + picture.suggestFileExtension();
                try (FileOutputStream fos = new FileOutputStream(imageFileName)) {
                    fos.write(picture.getContent());
                    System.out.println("파일 첨부 이미지 저장: " + imageFileName);
                }
            }

            // 문서의 텍스트를 출력합니다.
            Range range = document.getRange();
            String text = range.text();
            System.out.println("파일 내용: " + text);

        } catch (IOException e) {
            System.out.println("[ERROR] " + e.getMessage());
        }
    }

    private void extractTextAndImagesFromDocx(String filePath) {
        try (FileInputStream fis = new FileInputStream(filePath);
             XWPFDocument document = new XWPFDocument(fis)) {

            // Extract text
            StringBuilder textBuilder = new StringBuilder();
            for (XWPFParagraph paragraph : document.getParagraphs()) {
                textBuilder.append(paragraph.getText()).append("\n");
            }
            String text = textBuilder.toString();
            System.out.println("파일 내용: " + text);

            // Extract images
            // 일단 이미지 추출은 배제
//            List<XWPFPictureData> pictures = document.getAllPictures();
//            for (int i = 0; i < pictures.size(); i++) {
//                XWPFPictureData picture = pictures.get(i);
//                String imageFileName = "extracted_image_" + (i + 1) + "." + picture.suggestFileExtension();
//                try (FileOutputStream fos = new FileOutputStream(imageFileName)) {
//                    fos.write(picture.getData());
//                    System.out.println("파일 첨부 이미지 저장: " + imageFileName);
//                }
//            }

        } catch (IOException e) {
            System.out.println("[ERROR] " + e.getMessage());
        }
    }
}
