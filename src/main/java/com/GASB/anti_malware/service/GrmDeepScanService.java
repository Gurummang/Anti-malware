package com.GASB.anti_malware.service;

import com.GASB.anti_malware.model.entity.StoredFile;
import com.GASB.anti_malware.repository.StoredFileRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.io.IOException;

@Service
public class GrmDeepScanService {

    private final StoredFileRepository storedFileRepository;

    @Autowired
    public GrmDeepScanService(StoredFileRepository storedFileRepository){
        this.storedFileRepository = storedFileRepository;
    }

    // 서비스를 하나씩 더 만드는 게 나을 듯
    @Async("taskExecutor")
    public void DeepScanStart(long fileId) throws IOException {
        String type = ReturnType(fileId);
        switch (type) {
            case "exe" -> {
                // 실행 파일에 대한 처리
                System.out.println("Executing scan for executable file");
            }
            case "img" -> {
                // 이미지 파일에 대한 처리
                System.out.println("Executing scan for image file");
            }
            case "word" -> {
                // 문서 파일에 대한 처리
                System.out.println("Executing scan for document file");
            }
            default -> {
                // 기타 파일에 대한 처리
                System.out.println("Executing scan for other types of file");
            }
        }

    }

    private String ReturnType(long fileId) throws IOException{
        StoredFile storedFile = storedFileRepository.findById(fileId);

        if (storedFile == null) {
            throw new IOException("File not found with ID: " + fileId);
        }

        String type = storedFile.getType();

        if (type == null) {
            throw new IOException("Type not found: " + fileId);
        }

        return switch (type.toLowerCase()) {
            // 파일 케이스 추가 가능
            case "exe", "dll", "elf" -> "exe";
            case "jpg", "jpeg", "png", "gif" -> "img";
            case "doc", "docx", "pdf", "txt" -> "word";
            default -> "else";
        };

    }
}
