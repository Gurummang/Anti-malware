package com.GASB.anti_malware.service;

import com.GASB.anti_malware.model.entity.StoredFile;
import com.GASB.anti_malware.repository.StoredFileRepository;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.Optional;

import org.slf4j.LoggerFactory;

@Service
public class GrmDeepScanService {

    private static final Logger logger = LoggerFactory.getLogger(GrmDeepScanService.class);
    private final StoredFileRepository storedFileRepository;

    @Autowired
    public GrmDeepScanService(StoredFileRepository storedFileRepository){
        this.storedFileRepository = storedFileRepository;
    }

    // 서비스를 하나씩 더 만드는 게 나을 듯
    // 스캔 끝나면 grm_status 1로 업데이트 하기 (sprint 2)
    @Async("taskExecutor")
    public void DeepScanStart(long fileId) {
        try {
            String type = ReturnType(fileId);
            switch (type) {
                case "exe" -> {
                    // 실행 파일에 대한 처리
                    System.out.println("Executing scan for executable file");
                }
                case "img" -> {
                    // 이미지 파일에 대한 처리
                    System.out.println("Executing scan for image file");
                }
                case "word" -> {
                    // 문서 파일에 대한 처리
                    System.out.println("Executing scan for document file");
                }
                default -> {
                    // 기타 파일에 대한 처리
                    System.out.println("Executing scan for other types of file");
                }
            }


        } catch (IOException e) {
            logger.error("Error during deep scan for file ID: {}", fileId, e);
        } catch (Exception e) {
            logger.error("Unexpected error during deep scan for file ID: {}", fileId, e);
        }
    }

    private String ReturnType(long fileId) throws IOException{
        Optional<StoredFile> optionalStoredFile= storedFileRepository.findById(fileId);
        if (optionalStoredFile.isEmpty()) {
            logger.error("File not found with ID: {}", fileId);
            throw new IOException("File not found with ID: " + fileId);
        }

        StoredFile storedFile = optionalStoredFile.get();


        String type = storedFile.getType();

        if (type == null) {
            logger.error("Type not found for file ID: {}", fileId);
            throw new IOException("Type not found for file ID: " + fileId);
        }

        return switch (type.toLowerCase()) {
            case "exe", "dll", "elf" -> "exe";
            case "jpg", "jpeg", "png", "gif" -> "img";
            case "doc", "docx", "pdf", "txt" -> "word";
            default -> {
                logger.warn("Unknown file type for file ID: {}, type: {}", fileId, type);
                yield "else";
            }
        };
    }
}
