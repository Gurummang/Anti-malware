package com.GASB.anti_malware.service;

import com.GASB.anti_malware.model.entity.FileStatus;
import com.GASB.anti_malware.model.entity.StoredFile;
import com.GASB.anti_malware.repository.FileStatusRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import com.GASB.anti_malware.repository.StoredFileRepository;

@Service
public class StoredFileService {

        private final StoredFileRepository storedFileRepository;
        private final FileStatusRepository fileStatusRepository;

        @Autowired
        public StoredFileService(StoredFileRepository storedFileRepository, FileStatusRepository fileStatusRepository) {
            this.storedFileRepository = storedFileRepository;
            this.fileStatusRepository = fileStatusRepository;
        }

        public StoredFile saveStoredFile(StoredFile storedFile) {
            // FileStatus 객체 생성
            FileStatus fileStatus = new FileStatus();
            fileStatus.setStoredFile(storedFile);
            storedFile.setFileStatus(fileStatus); // 파일 status -1로 자동 설정

            return storedFileRepository.save(storedFile);
        }

        public boolean existsBySaltedHash(String saltedHash) {
            return storedFileRepository.findBySaltedHash(saltedHash).isPresent();
        }

        public void updateVtStatus(Long fileId, int status) {
            // fileStatus 테이블에서 해당 파일 ID로 상태를 업데이트
            FileStatus fileStatus = fileStatusRepository.findByStoredFileId(fileId);
            if (fileStatus != null) {
                fileStatus.setVtStatus(status);
                fileStatusRepository.save(fileStatus);
            }
        }
}

